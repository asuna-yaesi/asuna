<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒƒã‚ºå›³é‘‘</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/wishlist.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <div class="wrapper">
        <header class="header">
            <h1>æ¬²ã—ã„ã‚‚ã®ãƒªã‚¹ãƒˆ</h1>
            <div class="icon">
                <i class="fas fa-cog"></i>
                <div class="menu">
                    <a href="#" id="clearWishlist">ãƒ»ãƒªã‚»ãƒƒãƒˆ</a>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢">
                <button id="searchButton">ğŸ”</button>
                <button id="clearSearchResults" style="display: none;">Ã—</button>
            </div>

            <div class="status-button-container">
                <button id="changeStatusButton" class="change-button">
                    <span class="material-icons" style="vertical-align: middle;">autorenew</span>
                    <span id="statusText">å…¨ã¦</span>
                </button>
            </div>

            <div class="button-group">
                <button id="goodsListButton" class="scroll-to-top" onclick="redirectToIndex()">ã‚°ãƒƒã‚ºä¸€è¦§</button>
                <button id="wishlistButton" class="scroll-to-top" onclick="changePage(1)">æ¬²ã—ã„ã‚‚ã®</button>
            </div>
        </div>

        <div id="imageContainer">
            {% for item in image_links %}
                <div class="image-container">
                    <a href="{{ item.link }}"><img src="{{ item.image_url }}" alt="Image"></a>
                    <img src="{{ url_for('static', filename='icons/heart-regular.svg') }}" class="heart-icon" alt="Heart Icon">
                    <img src="{{ url_for('static', filename='icons/check-circle-regular.svg') }}" class="check-icon" alt="Check Icon">
                    <p class="hidden-text">{{ item.other_text }}</p> <!-- å•†å“ã®ãã®ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆ -->
                </div>
            {% endfor %}
        </div>

        <div id="overlay" class="overlay"></div>

        <div class="pagination-container">
            <div class="pagination" id="pagination"></div>
        </div>
    </div> <!-- wrapper end -->

    <footer class="footer">
        <div class="footer-top">
            <div class="footer-cell">
                <a href="{{ url_for('home') }}">ãƒ›ãƒ¼ãƒ </a>
            </div>
            <div class="footer-cell">ä½¿ç”¨æ–¹æ³•</div>
        </div>
        <div class="footer-bottom">
            <div class="footer-cell">é€£çµ¡å…ˆ</div>
            <div class="footer-cell">å…è²¬äº‹é …</div>
        </div>
        <div class="footer-copyright">
            Copyright Â© 2024 ã‚°ãƒƒã‚ºå›³é‘‘. All rights reserved.
        </div>
    </footer>

    <script>
        var imageContainer = document.getElementById("imageContainer");
        var paginationContainer = document.getElementById("pagination");
        var maxRows = 36;
        var currentPage = 1;
        var clickedImageUrls = JSON.parse(localStorage.getItem("clickedImageUrls")) || [];
        var checkedImageUrls = JSON.parse(localStorage.getItem("checkedImageUrls")) || [];

        // ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸç”»åƒãƒªãƒ³ã‚¯ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®å¤‰æ•°ã‚’è¿½åŠ 
        var filteredImageLinks = clickedImageUrls;

        var statuses = ["å…¨ã¦", "æœªå…¥æ‰‹", "å…¥æ‰‹æ¸ˆ"]; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é…åˆ—
        var currentStatusIndex = 0; // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ"å…¨ã¦"ï¼‰


        document.addEventListener("DOMContentLoaded", function () {

            // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«URLã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ
            var urlParams = new URLSearchParams(window.location.search);
            currentPage = parseInt(urlParams.get("page")) || 1;
            var searchQuery = urlParams.get("search") || "";
            document.getElementById("searchInput").value = searchQuery;
            document.getElementById("statusText").textContent = statuses[currentStatusIndex];

            if (searchQuery) {
                // æ¤œç´¢ã‚¯ã‚¨ãƒªãŒã‚ã‚‹å ´åˆã¯æ¤œç´¢ã‚’å®Ÿè¡Œ
                var searchWords = searchQuery.split(/\s+/).filter(function(word) {
                    return word.length > 0;  // ç©ºã®ãƒ¯ãƒ¼ãƒ‰ã¯é™¤å¤–
                });
                filteredImageLinks = clickedImageUrls.filter(function(image) {
                    return searchWords.every(function(word) {
                        return image.other_text && image.other_text.toLowerCase().includes(word);
                    });
                });
            }



            document.getElementById("changeStatusButton").addEventListener("click", function () {
                currentStatusIndex = (currentStatusIndex + 1) % statuses.length;
                const currentStatus = statuses[currentStatusIndex];
                document.getElementById("statusText").textContent = currentStatus;

                updateOverlay(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ›´æ–°
            });




            document.querySelector('.icon').addEventListener('click', function () {
                const menu = document.querySelector('.menu');
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });

            document.getElementById('clearWishlist').addEventListener('click', function (e) {
                e.preventDefault();   

                if (confirm("æœ¬å½“ã«æ¬²ã—ã„ã‚‚ã®ãƒªã‚¹ãƒˆã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
                    localStorage.removeItem("clickedImageUrls");

                    alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");

ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€   filteredImageLinks = [];
                    clickedImageUrls = [];         
                    displayImages(); 
                }
            });

            document.addEventListener('click', function (e) {
                const menu = document.querySelector('.menu');
                const icon = document.querySelector('.icon');
                if (!icon.contains(e.target)) {
                    menu.style.display = 'none';
                }
            });

            // æ¤œç´¢æ©Ÿèƒ½
            document.getElementById("searchButton").addEventListener("click", function() {
                var searchText = document.getElementById("searchInput").value.toLowerCase();

                // æ¤œç´¢æ–‡å­—åˆ—ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã—ã€å„ãƒ¯ãƒ¼ãƒ‰ã‚’é…åˆ—ã«
                var searchWords = searchText.split(/\s+/).filter(function(word) {
                    return word.length > 0;  // ç©ºã®ãƒ¯ãƒ¼ãƒ‰ã¯é™¤å¤–
                }); 

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†: other_textã«æ¤œç´¢æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æ®‹ã™
                filteredImageLinks = clickedImageUrls.filter(function (image) {
                    return searchWords.every(function (word) {
                        return image.other_text && image.other_text.toLowerCase().includes(word);
                    });
                });

                // ãƒ•ã‚£ãƒ«ã‚¿çµæœã«åŸºã¥ã„ã¦ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                if (filteredImageLinks.length !== clickedImageUrls.length || filteredImageLinks.length === 0) {
                    document.getElementById("clearSearchResults").style.display = "inline-block"; // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                } else {
                    document.getElementById("clearSearchResults").style.display = "none"; // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                }

                // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°
                var url = new URL(window.location.href);
                url.searchParams.set("search", searchText);
                url.searchParams.set("page", 1); // æ¤œç´¢æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
                window.history.pushState({}, "", url);

        ã€€ã€€    currentPage = 1; 
        ã€€ã€€    displayImages();

            });

            // æ¤œç´¢ãƒãƒ¼ã§ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã‚’æŠ¼ã—ãŸã¨ãã«æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            document.getElementById("searchInput").addEventListener("keydown", function(event) {
                if (event.key === "Enter") { // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã‚’åˆ¤å®š
                    event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãªã©ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²ã
                    document.getElementById("searchButton").click(); // æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                }
            });

ã€€ã€€ã€€ã€€    document.getElementById("clearSearchResults").addEventListener("click", function() {

   ã€€ã€€ã€€ã€€     document.getElementById("searchInput").value = "";

                filteredImageLinks = clickedImageUrls;
                currentPage = 1;

                // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                var url = new URL(window.location.href);
                url.searchParams.delete("search");
                url.searchParams.set("page", 1);
                window.history.pushState({}, "", url);

                displayImages();

            });


            // æœ€åˆã®ç”»åƒè¡¨ç¤ºã‚’å®Ÿè¡Œ
            displayImages();
        });

        function changePage(pageNumber) {

            // ç¾åœ¨ã®URLã‚’å–å¾—
            var url = new URL(window.location.href);
            // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®š
            url.searchParams.set("page", pageNumber); 
            // URLã‚’æ›´æ–°
            window.history.pushState({}, "", url);

            currentPage = pageNumber; // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æ›´æ–°

            displayImages(); // ç”»åƒã‚’å†æç”»
        }


        function redirectToIndex() {
            window.location.href = "{{ url_for('index') }}";
        }




        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®æ›´æ–°é–¢æ•°
        function updateOverlay() {
            const currentStatus = statuses[currentStatusIndex];

            const imgContainers = document.querySelectorAll(".image-container");
            imgContainers.forEach((container) => {
                const checkIcon = container.querySelector(".check-icon");
                const isChecked = checkIcon.src.includes("check-circle-solid.svg"); 
                const overlayElement = container.querySelector(".overlay"); // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¦ç´ 

                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®é©ç”¨
                if (currentStatus === "æœªå…¥æ‰‹" && isChecked) {
                    container.classList.add("with-overlay");
                } else if (currentStatus === "å…¥æ‰‹æ¸ˆ" && !isChecked) {
                    container.classList.add("with-overlay");
                } else {
                    container.classList.remove("with-overlay");
                }
            });
        }




        function displayImages() {

            imageContainer.innerHTML = "";
            
            var totalImagesToShow = maxRows;
            var start = (currentPage - 1) * maxRows;
            var end = start + totalImagesToShow;

            for (var i = start; i < end && i < filteredImageLinks.length; i++) {
                var imgContainer = document.createElement("div");
                imgContainer.className = "image-container";

                var linkElement = document.createElement("a");
                linkElement.href = filteredImageLinks[i].link || "#";
                linkElement.target = "_blank"; 

                var imgElement = document.createElement("img");
                imgElement.src = filteredImageLinks[i].image_url;
                imgElement.alt = "ä¿å­˜ã•ã‚ŒãŸç”»åƒ";

                linkElement.appendChild(imgElement); // ç”»åƒã‚’ãƒªãƒ³ã‚¯ã«ãƒ©ãƒƒãƒ—

                var overlayElement = document.createElement("div"); // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¦ç´ 
                overlayElement.className = "overlay"; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                imgContainer.appendChild(overlayElement);

                var otherTextElement = document.createElement("p");
                otherTextElement.textContent = filteredImageLinks[i].other_text;  // other_text ã‚’æŒ¿å…¥

                var heartIcon = document.createElement("img");
                heartIcon.src = clickedImageUrls.some(item => item.image_url === filteredImageLinks[i].image_url)
                    ? "{{ url_for('static', filename='icons/heart-solid.svg') }}"
                    : "{{ url_for('static', filename='icons/heart-regular.svg') }}";
                    heartIcon.className = "heart-icon";
                    heartIcon.alt = "Heart Icon";

                var checkIcon = document.createElement("img");
                checkIcon.src = checkedImageUrls.some(item => item.image_url === filteredImageLinks[i].image_url)
                    ? "{{ url_for('static', filename='icons/check-circle-solid.svg') }}"
                    : "{{ url_for('static', filename='icons/check-circle-regular.svg') }}";
                    checkIcon.className = "check-icon";
                    checkIcon.alt = "Check Icon";


                heartIcon.addEventListener("click", function() {

                    var clickedImgElement = this.previousElementSibling.querySelector("img");
                    var clickedUrl = clickedImgElement.src;

                    var matchingItem = clickedImageUrls.find(function (item) {
                        return item.image_url === clickedUrl;
                    });

                    if (matchingItem) {
                        if (this.src.includes("heart-regular.svg")) {
                            this.src = "{{ url_for('static', filename='icons/heart-solid.svg') }}";
                            if (!clickedImageUrls.some(item => item.image_url === matchingItem.image_url)) {
                                clickedImageUrls.push(matchingItem);
                            }
                        } else {
                            this.src = "{{ url_for('static', filename='icons/heart-regular.svg') }}";
                            clickedImageUrls = clickedImageUrls.filter(item => item.image_url !== matchingItem.image_url);
                        }

                        localStorage.setItem("clickedImageUrls", JSON.stringify(clickedImageUrls));
                        filteredImageLinks = clickedImageUrls;
                        displayImages();
                    }
                });

                checkIcon.addEventListener("click", function() {

                    var checkedImgElement = this.previousElementSibling.previousElementSibling.querySelector("img");
                    var checkedUrl = checkedImgElement.src;

                    var matchingItem = filteredImageLinks.find(function (item) {
                        return item.image_url === checkedUrl;
                    });

                    if (matchingItem) {
                        if (this.src.includes("check-circle-regular.svg")) {
                            this.src = "{{ url_for('static', filename='icons/check-circle-solid.svg') }}";
                            if (!checkedImageUrls.some(item => item.image_url === matchingItem.image_url)) {
                                checkedImageUrls.push(matchingItem);
                            }
                        } else {
                            this.src = "{{ url_for('static', filename='icons/check-circle-regular.svg') }}";
                            checkedImageUrls = checkedImageUrls.filter(item => item.image_url !== matchingItem.image_url);
                        }

                        localStorage.setItem("checkedImageUrls", JSON.stringify(checkedImageUrls));
                        
                        displayImages();
                    }
                });

                imgContainer.appendChild(linkElement);
                imgContainer.appendChild(heartIcon);
                imgContainer.appendChild(checkIcon);
                       
                imageContainer.appendChild(imgContainer);
            }

            updatePagination();

            if (imageContainer.childNodes.length === 0 && currentPage > 1) {
                currentPage = Math.max(1, currentPage - 1);
                displayImages();
            }

            updateOverlay(); // è¡¨ç¤ºå¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ›´æ–°
        }

        function updatePagination() {
            paginationContainer.innerHTML = "";
            var totalPages = Math.ceil(filteredImageLinks.length / maxRows);
            for (var i = 1; i <= totalPages; i++) {
                var pageButton = document.createElement("a");
                pageButton.href = "#"; // ãƒšãƒ¼ã‚¸é·ç§»é˜²æ­¢ç”¨ãƒªãƒ³ã‚¯
                pageButton.textContent = i;
                pageButton.classList.add("page-link");
                if (i === currentPage) {
                    pageButton.classList.add("active");
                }

                pageButton.addEventListener("click", function (e) {
                    e.preventDefault();
                    var clickedPageNumber = parseInt(this.textContent);

                    if (clickedPageNumber === currentPage) {
                        return;
                    }
                    changePage(clickedPageNumber);
                });

                paginationContainer.appendChild(pageButton);
            }
        }
        
    </script>

</body>
</html>